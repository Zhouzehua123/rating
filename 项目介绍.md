# 为什么选用这种架构方式？

1.主从数据库的架构方式

一开始我实现了将数据库进行主从高可用部署，以支持读写分离，

后来我问了我的一些朋友让他们看一下，

他们说在这个高并发评论系统的场景下，不是大厂做的架构模式

我查了一些资料，就是发现如果做LIKE %这样的条件查询，

他会导致索引失效进而直接全表扫描，

这样的话从库的压力也很大，尤其面临上百万条搜索评价的场景。

假设用户点击某条评价，要看完整信息：评价内容 + 商家回复 + 申诉状态。

3个表的连接，在高并发场景下（日均百万查询）从库压力巨大。

而ES中他已经在review-job模块把kafka的数据拼成了一个宽表，

查询的时候不用连表，效率很高。

2.后面我学到了redis+数据库架构

我了解到Redis无法做全文搜索和模糊匹配，

缓存未命中时查MySQL很慢，

而且redis的内存成本也是比较大的

3.后来我参考了一些java的开源项目架构方案，mysql+ES+redis

redis负责热点数据的精准查询，

ES负责模糊查询，范围搜索等，

而且他的磁盘存储要比redis成本小，

可以把mysql全量数据拿来进行磁盘存储。

因此我上网参考了业界的一些架构方案，

决定热数据走redis，冷数据走ES，

事务级写入或者修复数据走mysql保证一致性。

# 2.为什么要设计redis+singleflight这种模式

singleflight是go语言的一个库，

解决的是短时间合并请求，解决大并发的问题。

如果只有redis+ES的话，会出现比入1w个请求，

然后缓存没有造成击穿，导致全部请求打到ES造成崩溃。

那用Singleflight就相当于先让第一个请求查看缓存，

redis中没有的话，放行一个请求到ES拿数据返回给redis，

然后redis再把这个数据返回给剩下的所有请求。

# 3.kratos框架开发流程是什么

嗯，好的。其实我用我项目里"用户创建评价"这个功能来给你讲吧。

【第1步：定义接口（proto文件）】
首先，我得在 api/review/v1/review.proto 里面定义这个接口，

就是说明一下前端要传什么参数给我（userID、orderID、score这些），

我要返回什么（reviewID）。然后框架很聪明，

它能自动帮我生成 HTTP 和 gRPC 两种方式的代码，

我就不用手写路由了，这样挺省事儿的。

【第2步：实现 Service 层】
我在里面写一个方法，这个方法的作用就是接收前端的请求，

然后我调用下面的业务层，再把结果返回给前端。

【第3步：写业务逻辑（Biz层）】
然后真正的业务逻辑我在 biz层 里面写。

比如说，我要检查这个订单有没有被评价过，

如果已经评价过了，就不能再评价，这就是业务规则嘛。

还有生成一个评价 ID，用的是雪花算法。

这些都属于业务逻辑，我觉得这样分开的好处就是，

万一需求改了，我只需要改这一层，其他层不用动。

【第4步：数据访问（Data层）】
最后，我需要把这个评价存到数据库里，

这就是 Data 层的工作了。我在里面写了一个方法，

就负责把数据存到 MySQL。或者查询数据走redis+ES。

【第5步：配置服务器（Server）】
然后我还要配置一下 HTTP 和 gRPC 的服务器。

【第6步：依赖注入（Wire）】
奥对，最后一步就是用 Wire 这个工具做依赖注入。

比如就是我有一堆类，它们之间有依赖关系，

比如 Service 依赖 Biz，Biz 依赖 Data。

然后在wire.go 里面声明一下依赖，然后执行 wire 命令，

它就自动生成代码了。

# 4.k8s

"我的项目中有四个微服务，

原本分别部署在三台电脑上。

后来想尝试实现一下分布式集群方案，

好处是一个服务挂了，不会整体挂掉，高可用，

而且服务发现可以解决每次我手动改IP的问题，

他会自动找到可用的pod，然后pod挂的话他也会自动重启。


Pod 就是 K8s 里最小的部署单位，你可以把它理解成一个 **“迷你小服务器”**。

Kafka 的 Pod 呢，就是专门用来跑 Kafka 服务的这个小服务器。

一个 Kafka Pod 对应一个 Kafka 节点，好几个 Pod 就组成了 Kafka 集群。

# 5.自我介绍

面试官您好，我是周泽华。

我现在就读东南大学电子信息专业，目前是研二，

对后端开发特别感兴趣，最近一直在学习微服务架构和分布式系统的知识。

我主要做过一个电商评价系统的项目。

评价服务是为公司电商业务提供了用户评价相关能力。

整个评价服务包含 C、B 端和 O 端三部分，涉及 C 端用户发表评价，

O 端运营审核评价以及 B 端商家查看 / 回复评价等主要业务流程。

涉及 MySQL、Redis、Elasticsearch、Kafka 等多个组件。

就是我针对**高并发查询**做了一套CQRS架构：

然后数据同步这块，我用了 Canal + Kafka 的组合，
然后 review-job 这个微服务去消费消息并同步到 Elasticsearch。

通过这个项目，我理解了 CQRS 架构、分布式缓存、微服务通信这些概念，
也学会了用 Kratos 框架。

我了解到贵公司也有处理留言或弹幕评论这种高并发的场景，

我认为我如果有机会也能够学到更多知识。
